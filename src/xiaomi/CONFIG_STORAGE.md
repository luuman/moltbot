# å°ç±³ç™»å½•ä¿¡æ¯ç¼“å­˜æœºåˆ¶è¯¦è§£

## ğŸ“ é…ç½®æ–‡ä»¶å­˜å‚¨ä½ç½®

### é»˜è®¤è·¯å¾„
```bash
~/.moltbot/xiaomi/xiaomi_config.json
```

**å®Œæ•´è·¯å¾„ç¤ºä¾‹**:
```bash
/home/sichengli/.moltbot/xiaomi/xiaomi_config.json
```

### ä»£ç å®šä¹‰
```typescript
// src/xiaomi/storage.ts
const DEFAULT_STORAGE_DIR = path.join(os.homedir(), ".moltbot", "xiaomi");
const DEFAULT_CONFIG_FILE = "xiaomi_config.json";
```

---

## ğŸ“¦ é…ç½®æ–‡ä»¶å†…å®¹ç»“æ„

```json
{
  // 1. OAuthé…ç½®
  "cloud_server": "cn",                        // äº‘æœåŠ¡å™¨åŒºåŸŸ
  "client_id": "2882303761520251711",         // OAuthå®¢æˆ·ç«¯ID
  "redirect_url": "http://homeassistant.local:8123",
  "uuid": "6f5ded7288abcb69d90b3377423eafa3",  // è®¾å¤‡UUIDï¼ˆç”¨äºOAuthï¼‰

  // 2. è®¿é—®ä»¤ç‰Œ
  "token": {
    "access_token": "V3_6Bnk2Pfgf...",        // è®¿é—®ä»¤ç‰Œï¼ˆç”¨äºAPIè°ƒç”¨ï¼‰
    "refresh_token": "R3_xsIo5DoFr...",       // åˆ·æ–°ä»¤ç‰Œï¼ˆç”¨äºç»­æœŸï¼‰
    "expires_in": 259200,                      // æœ‰æ•ˆæœŸï¼ˆç§’ï¼Œ3å¤©ï¼‰
    "expires_ts": 1770051575                   // è¿‡æœŸæ—¶é—´æˆ³
  },

  // 3. ç”¨æˆ·ä¿¡æ¯
  "user_info": {
    "miliaoNick": "æ¡ƒå±å±",                    // æ˜µç§°
    "miliaoIcon": "https://..."                // å¤´åƒURL
  },

  // 4. å®¶åº­å’Œæˆ¿é—´ä¿¡æ¯
  "homes": {
    "143001019698": {                          // å®¶åº­ID
      "home_id": "143001019698",
      "home_name": "çš‡å®«",
      "uid": "107089540",
      "dids": [...],                           // å®¶åº­çº§è®¾å¤‡åˆ—è¡¨
      "room_info": {                           // æˆ¿é—´ä¿¡æ¯
        "143001055496": {
          "room_id": "143001055496",
          "room_name": "å®¢å…",
          "dids": [                            // æˆ¿é—´å†…çš„è®¾å¤‡
            "289833424",                       // â† å°çˆ±éŸ³ç®±çš„DID
            "64131135",                        // â† æ‘„åƒæœº2çš„DID
            ...
          ]
        }
      }
    }
  },

  // 5. è®¾å¤‡è¯¦ç»†ä¿¡æ¯
  "devices": {
    "289833424": {                             // è®¾å¤‡DIDï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
      "did": "289833424",
      "model": "xiaomi.wifispeaker.lx05",     // è®¾å¤‡å‹å·
      "name": "å°çˆ±éŸ³ç®±Playï¼ˆ2019æ¬¾ï¼‰",         // è®¾å¤‡åç§°
      "type": "urn:miot-spec-v2:device:speaker:0000A015:xiaomi-lx05:1",
      "online": true,                          // åœ¨çº¿çŠ¶æ€
      "spec_type": "..."
    },
    "64131135": {
      "did": "64131135",
      "model": "isa.camera.isc5c1",
      "name": "æ‘„åƒæœº2",
      ...
    }
  }
}
```

---

## ğŸ”„ CLI å¦‚ä½•è°ƒç”¨å°çˆ±

### å®Œæ•´è°ƒç”¨æµç¨‹

#### 1. åˆå§‹åŒ–å®¢æˆ·ç«¯

```typescript
// src/xiaomi/cli.ts
const client = new XiaomiClient();
await client.init();  // â† è¿™é‡ŒåŠ è½½é…ç½®æ–‡ä»¶
```

**å†…éƒ¨æµç¨‹**:
```typescript
// src/xiaomi/client.ts
async init(): Promise<boolean> {
  // 1. ä»æ–‡ä»¶è¯»å–é…ç½®
  const savedConfig = await this.storage.loadConfig();
  //    â†’ è¯»å– ~/.moltbot/xiaomi/xiaomi_config.json

  if (savedConfig) {
    // 2. æ¢å¤é…ç½®
    this.config.cloud_server = savedConfig.cloud_server;
    this.config.client_id = savedConfig.client_id;
    this.uuid = savedConfig.uuid;

    // 3. æ¢å¤ç¼“å­˜æ•°æ®
    this.devices = savedConfig.devices;  // â† è®¾å¤‡åˆ—è¡¨
    this.homes = savedConfig.homes;      // â† å®¶åº­ä¿¡æ¯
    this.userInfo = savedConfig.user_info;

    // 4. åˆå§‹åŒ–HTTPå®¢æˆ·ç«¯ï¼ˆä½¿ç”¨access_tokenï¼‰
    if (savedConfig.token) {
      this.httpClient = new XiaomiHttpClient({
        cloud_server: savedConfig.cloud_server,
        access_token: savedConfig.token.access_token  // â† ç”¨äºAPIè®¤è¯
      });
      return true;  // å·²ç™»å½•
    }
  }

  return false;  // æœªç™»å½•
}
```

#### 2. æŸ¥æ‰¾è®¾å¤‡

```typescript
// ç”¨æˆ·æ‰§è¡Œ: xiaomi speak 289833424 "ä½ å¥½"
await client.loadDevices();  // ç¡®ä¿è®¾å¤‡åˆ—è¡¨æœ€æ–°

const device = client.getDevice('289833424');  // â† é€šè¿‡DIDæŸ¥æ‰¾è®¾å¤‡
// è¿”å›: {
//   did: "289833424",
//   model: "xiaomi.wifispeaker.lx05",
//   name: "å°çˆ±éŸ³ç®±Playï¼ˆ2019æ¬¾ï¼‰",
//   ...
// }
```

#### 3. åˆ›å»ºè®¾å¤‡æ§åˆ¶å™¨

```typescript
const xiaoai = client.createXiaoAISpeaker('289833424');
// â†“
// å†…éƒ¨å®ç°
createXiaoAISpeaker(deviceId: string): XiaoAISpeaker {
  const device = this.devices[deviceId];  // â† ä»ç¼“å­˜è·å–è®¾å¤‡ä¿¡æ¯
  return new XiaoAISpeaker(this.httpClient, device);
}
```

#### 4. æ‰§è¡Œæ“ä½œ

```typescript
await xiaoai.speak("ä½ å¥½");
// â†“
// å†…éƒ¨å®ç°
async speak(text: string): Promise<void> {
  await this.httpClient.executeAction({
    did: this.device.did,           // â† ä½¿ç”¨è®¾å¤‡DID
    siid: 5,                         // æ™ºèƒ½è¯­éŸ³æœåŠ¡
    aiid: 1,                         // play-textåŠ¨ä½œ
    in: [text]
  });
}
```

#### 5. HTTPè¯·æ±‚

```typescript
// src/xiaomi/http-client.ts
async executeAction(action: MIoTAction): Promise<any> {
  return await this.apiPost('/miotspec/action', {
    params: [{
      did: action.did,              // â† 289833424
      siid: action.siid,            // â† 5
      aiid: action.aiid,            // â† 1
      in: action.in                 // â† ["ä½ å¥½"]
    }]
  });
}

private async apiPost(endpoint: string, data: any): Promise<any> {
  const response = await fetch(url, {
    method: 'POST',
    headers: {
      'Authorization': this.access_token,  // â† ä½¿ç”¨ç¼“å­˜çš„tokenè®¤è¯
      ...
    },
    body: JSON.stringify(data)
  });
}
```

---

## ğŸ¯ å…³é”®ç‚¹æ€»ç»“

### é—®é¢˜1: ç™»å½•ä¿¡æ¯ç¼“å­˜åœ¨å“ªé‡Œï¼Ÿ

**ç­”æ¡ˆ**:
```
ä½ç½®: ~/.moltbot/xiaomi/xiaomi_config.json

åŒ…å«:
âœ… OAuthä»¤ç‰Œ (access_token, refresh_token)
âœ… ç”¨æˆ·ä¿¡æ¯ (æ˜µç§°ã€å¤´åƒ)
âœ… å®¶åº­å’Œæˆ¿é—´ç»“æ„
âœ… æ‰€æœ‰è®¾å¤‡çš„DIDå’Œè¯¦ç»†ä¿¡æ¯
```

### é—®é¢˜2: AIå¦‚ä½•çŸ¥é“æ€ä¹ˆè°ƒç”¨å°çˆ±ï¼Ÿ

**ç­”æ¡ˆ**:

1. **é€šè¿‡DIDè¯†åˆ«è®¾å¤‡**
   ```
   å‘½ä»¤: xiaomi speak 289833424 "ä½ å¥½"
                       â†‘
                    è®¾å¤‡DIDï¼ˆåœ¨é…ç½®æ–‡ä»¶ä¸­ï¼‰
   ```

2. **ä»é…ç½®æ–‡ä»¶åŠ è½½ä¿¡æ¯**
   ```typescript
   client.init()
   â†’ è¯»å– ~/.moltbot/xiaomi/xiaomi_config.json
   â†’ åŠ è½½è®¾å¤‡åˆ—è¡¨: devices["289833424"]
   â†’ è·å–è®¾å¤‡è¯¦æƒ…: { name: "å°çˆ±éŸ³ç®±", model: "xiaomi.wifispeaker.lx05", ... }
   ```

3. **ä½¿ç”¨ç¼“å­˜çš„tokenè®¤è¯**
   ```typescript
   httpClient.executeAction(...)
   â†’ ä½¿ç”¨ access_token è®¤è¯
   â†’ è°ƒç”¨å°ç±³äº‘API
   â†’ æ§åˆ¶è®¾å¤‡
   ```

---

## ğŸ” å¦‚ä½•æŸ¥çœ‹ä½ çš„é…ç½®

### æŸ¥çœ‹é…ç½®æ–‡ä»¶
```bash
# æŸ¥çœ‹å®Œæ•´é…ç½®
cat ~/.moltbot/xiaomi/xiaomi_config.json | jq '.'

# æŸ¥çœ‹è®¾å¤‡åˆ—è¡¨
cat ~/.moltbot/xiaomi/xiaomi_config.json | jq '.devices'

# æŸ¥çœ‹token
cat ~/.moltbot/xiaomi/xiaomi_config.json | jq '.token'

# æŸ¥çœ‹å°çˆ±éŸ³ç®±ä¿¡æ¯
cat ~/.moltbot/xiaomi/xiaomi_config.json | jq '.devices["289833424"]'
```

### æŸ¥çœ‹è®¾å¤‡DID
```bash
# åˆ—å‡ºæ‰€æœ‰è®¾å¤‡åŠå…¶DID
xiaomi devices
```

è¾“å‡º:
```
ğŸŸ¢ å°çˆ±éŸ³ç®±Playï¼ˆ2019æ¬¾ï¼‰
   DID: 289833424           â† è¿™å°±æ˜¯DID
   å‹å·: xiaomi.wifispeaker.lx05
```

---

## ğŸ”„ é…ç½®æ–‡ä»¶æ›´æ–°æ—¶æœº

### ä½•æ—¶ä¼šæ›´æ–°é…ç½®æ–‡ä»¶ï¼Ÿ

1. **é¦–æ¬¡ç™»å½•**
   ```bash
   xiaomi login-code <code>
   â†’ åˆ›å»ºé…ç½®æ–‡ä»¶
   â†’ ä¿å­˜tokenã€ç”¨æˆ·ä¿¡æ¯
   ```

2. **åŠ è½½è®¾å¤‡**
   ```bash
   xiaomi devices
   â†’ ä»äº‘ç«¯è·å–æœ€æ–°è®¾å¤‡åˆ—è¡¨
   â†’ æ›´æ–° devices å’Œ homes å­—æ®µ
   ```

3. **Tokenåˆ·æ–°**
   ```typescript
   // è‡ªåŠ¨åˆ·æ–°ï¼ˆtokenè¿‡æœŸå‰ï¼‰
   client.refreshToken()
   â†’ è·å–æ–°çš„ access_token
   â†’ æ›´æ–°é…ç½®æ–‡ä»¶
   ```

---

## ğŸ›  æ‰‹åŠ¨æ“ä½œé…ç½®

### æ¸…é™¤ç™»å½•ä¿¡æ¯
```bash
# æ–¹æ³•1: ä½¿ç”¨CLI
xiaomi logout

# æ–¹æ³•2: ç›´æ¥åˆ é™¤æ–‡ä»¶
rm ~/.moltbot/xiaomi/xiaomi_config.json
```

### æŸ¥çœ‹é…ç½®æ–‡ä»¶ä½ç½®
```bash
xiaomi info
```

è¾“å‡º:
```
é…ç½®æ–‡ä»¶: /home/sichengli/.moltbot/xiaomi/xiaomi_config.json
```

---

## ğŸ“Š å®Œæ•´æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  xiaomi speak 289833424 "ä½ å¥½"                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  XiaomiClient.init()                                    â”‚
â”‚  â†’ è¯»å– ~/.moltbot/xiaomi/xiaomi_config.json           â”‚
â”‚  â†’ åŠ è½½: token, devices, homes, user_info              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  client.getDevice('289833424')                          â”‚
â”‚  â†’ ä» config.devices["289833424"] è·å–è®¾å¤‡ä¿¡æ¯          â”‚
â”‚  â†’ è¿”å›: { did, model, name, type, online }            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  client.createXiaoAISpeaker('289833424')                â”‚
â”‚  â†’ åˆ›å»º XiaoAISpeaker å®ä¾‹                              â”‚
â”‚  â†’ ç»‘å®š httpClient (åŒ…å« access_token)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  xiaoai.speak("ä½ å¥½")                                   â”‚
â”‚  â†’ httpClient.executeAction({                           â”‚
â”‚      did: "289833424",                                  â”‚
â”‚      siid: 5,                                           â”‚
â”‚      aiid: 1,                                           â”‚
â”‚      in: ["ä½ å¥½"]                                       â”‚
â”‚    })                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  HTTP POST åˆ°å°ç±³äº‘API                                  â”‚
â”‚  URL: https://api.io.mi.com/app/miotspec/action         â”‚
â”‚  Headers:                                               â”‚
â”‚    Authorization: access_token (ä»é…ç½®è¯»å–)             â”‚
â”‚  Body:                                                  â”‚
â”‚    { did: "289833424", siid: 5, aiid: 1, in: ["ä½ å¥½"] }â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å°ç±³äº‘ â†’ å°çˆ±éŸ³ç®±                                       â”‚
â”‚  å°çˆ±éŸ³ç®±æ’­æ”¾: "ä½ å¥½"                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” å®‰å…¨è¯´æ˜

### Token å®‰å…¨
- âœ… é…ç½®æ–‡ä»¶åªå­˜å‚¨åœ¨æœ¬åœ°
- âœ… ä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨
- âš ï¸ access_token æœ‰æ•ˆæœŸ3å¤©ï¼ˆè‡ªåŠ¨åˆ·æ–°ï¼‰
- âš ï¸ é…ç½®æ–‡ä»¶æ˜æ–‡å­˜å‚¨ï¼ˆå»ºè®®ä¿æŠ¤æƒé™ï¼‰

### å»ºè®®
```bash
# è®¾ç½®é…ç½®æ–‡ä»¶æƒé™ï¼ˆä»…å½“å‰ç”¨æˆ·å¯è¯»å†™ï¼‰
chmod 600 ~/.moltbot/xiaomi/xiaomi_config.json
```

---

## æ€»ç»“

**é—®é¢˜**: "ç™»å½•ä¿¡æ¯ç¼“å­˜åœ¨ä½•å¤„ï¼ŒAIå¦‚ä½•çŸ¥é“ä½¿ç”¨æ€ä¹ˆè°ƒç”¨å°çˆ±"

**ç­”æ¡ˆ**:

1. **ç¼“å­˜ä½ç½®**
   ```
   ~/.moltbot/xiaomi/xiaomi_config.json
   ```

2. **åŒ…å«ä¿¡æ¯**
   - OAuthä»¤ç‰Œï¼ˆç”¨äºè®¤è¯ï¼‰
   - è®¾å¤‡åˆ—è¡¨ï¼ˆåŒ…å«æ¯ä¸ªè®¾å¤‡çš„DIDã€åç§°ã€å‹å·ï¼‰
   - å®¶åº­å’Œæˆ¿é—´ç»“æ„

3. **è°ƒç”¨æµç¨‹**
   ```
   ç”¨æˆ·è¾“å…¥DID (289833424)
   â†“
   ä»é…ç½®æ–‡ä»¶è¯»å–è®¾å¤‡ä¿¡æ¯
   â†“
   ä½¿ç”¨ç¼“å­˜çš„tokenè®¤è¯
   â†“
   è°ƒç”¨å°ç±³äº‘API
   â†“
   æ§åˆ¶è®¾å¤‡
   ```

4. **å…³é”®æ ‡è¯†**
   - **DID (Device ID)**: è®¾å¤‡çš„å”¯ä¸€æ ‡è¯†ç¬¦
   - **access_token**: ç”¨äºAPIè®¤è¯
   - **è®¾å¤‡å‹å·**: ç¡®å®šè®¾å¤‡æ”¯æŒå“ªäº›åŠŸèƒ½

ä¸éœ€è¦æ¯æ¬¡éƒ½é‡æ–°ç™»å½•ï¼Œå› ä¸ºæ‰€æœ‰ä¿¡æ¯éƒ½å·²ç¼“å­˜åœ¨æœ¬åœ°é…ç½®æ–‡ä»¶ä¸­ï¼
